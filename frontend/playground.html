<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nexus - Multi-Agent Playground</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- Load ethers first -->
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
        type="application/javascript"></script>
    
    <!-- Then load EAS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@ethereum-attestation-service/eas-sdk@0.28.0/dist/umd/eas-sdk.min.js"></script>
    
    <!-- Add this script to verify libraries are loaded -->
    <script>
        window.addEventListener('load', () => {
            if (typeof window.ethers === 'undefined') {
                console.error('Ethers library not loaded!');
            } else {
                console.log('Ethers library loaded successfully');
            }
            
            if (typeof window.EAS === 'undefined') {
                console.error('EAS SDK not loaded!');
            } else {
                console.log('EAS SDK loaded successfully');
            }
        });
    </script>
    <style>
        :root {
            --primary: #2a2b38;
            --secondary: #1f2029;
            --accent: #5d5dff;
            --text: #9498a4;
            --white: #ffffff;
            --user-msg: #2b2c3d;
            --ai-msg: #32334a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: var(--secondary);
            color: var(--text);
            min-height: 100vh;
            padding-top: 80px;
        }
        
        .navbar {
            background: var(--primary);
            padding: 1rem 2rem;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            color: var(--white);
            text-decoration: none;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo span {
            color: var(--accent);
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
        }
        .metamask-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
        }

        .metamask-button {
            background-color: #f6851b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .metamask-button:hover {
            background-color: #e2761b;
        }

        #walletStatus {
            font-size: 14px;
            color: var(--text);
        }
        
        .nav-link {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .nav-link:hover {
            color: var(--white);
        }
        
        .playground-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            background: var(--primary);
            border-radius: 15px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        .agent-selection-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .agent-dropdown {
            flex: 1;
            background: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .add-agent-btn {
            background: var(--accent);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-agent-btn:hover {
            transform: translateY(-2px);
        }
        
        .agent-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .agent-toggle:hover {
            transform: translateX(5px);
        }
        
        .agent-toggle.active {
            background: var(--accent);
            color: var(--white);
        }
        
        .agent-toggle img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        
        .chat-container {
            background: var(--primary);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 80px;
            width: 100%;
            max-width: 100%;
        }
        
        .message {
            padding: 1rem;
            border-radius: 10px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
            position: relative;
            display: inline-block;
            margin: 0.5rem 0;
            width: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .user-message {
            background: var(--user-msg);
            color: var(--white);
            align-self: flex-end;
        }
        
        .ai-message {
            background: var(--ai-msg);
            color: var(--white);
            align-self: flex-start;
            min-width: 200px;
        }
        
        .message-content {
            white-space: pre-wrap;
            line-height: 0.9;
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
        }
        
        .message-content p {
            margin: 0 0 0.5rem 0;
        }
        
        .message-content p:last-child {
            margin-bottom: 0;
        }
        
        .message-content ul,
        .message-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .message-content li {
            margin: 0.25rem 0;
        }
        
        .agent-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding-right: 60px;
        }
        
        .rating-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--accent);
            color: var(--white);
            border: none;
            border-radius: 5px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        
        .rating-button:hover {
            opacity: 1;
        }
        
        .message-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: var(--primary);
            border-top: 1px solid rgba(255,255,255,0.1);
            border-radius: 0 0 15px 15px;
        }
        
        .message-input-wrapper {
            display: flex;
            gap: 1rem;
            background: var(--secondary);
            padding: 0.5rem;
            border-radius: 10px;
        }
        
        .message-input {
            flex-grow: 1;
            background: none;
            border: none;
            color: var(--white);
            padding: 0.5rem;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 150px;
        }
        
        .send-button {
            background: var(--accent);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-button:hover {
            transform: translateY(-2px);
        }
        
        .send-button:disabled {
            background: var(--text);
            cursor: not-allowed;
            transform: none;
        }
        
        /* Rating Modal Styles */
        .rating-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .rating-modal.active {
            display: flex;
        }
        
        .rating-content {
            background: var(--primary);
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            color: var(--white);
            animation: fadeIn 0.3s ease;
        }
        
        .close-rating {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }
        
        .close-rating:hover {
            color: var(--white);
        }
        
        .rating-category {
            margin: 1rem 0;
        }
        
        .rating-stars {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .star {
            cursor: pointer;
            color: var(--text);
            transition: color 0.3s ease;
            font-size: 1.2rem;
        }
        
        .star.active {
            color: #ffd700;
        }
        
        .rating-feedback {
            margin-top: 1.5rem;
        }
        
        .rating-feedback textarea {
            width: 100%;
            background: var(--secondary);
            border: none;
            border-radius: 8px;
            padding: 0.8rem;
            color: var(--white);
            margin-top: 0.5rem;
            min-height: 100px;
            resize: vertical;
        }
        
        .submit-rating {
            background: var(--accent);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
            transition: transform 0.3s ease;
            width: 100%;
        }
        
        .submit-rating:hover {
            transform: translateY(-2px);
        }
        
        .rating-header {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--white);
            font-size: 1.2rem;
            font-weight: bold;
        }

        .bullet-point {
            margin: 0.25rem 0 0.25rem 1.25rem;
            position: relative;
        }
        
        .bullet-point:before {
            content: "•";
            position: absolute;
            left: -1rem;
            color: var(--accent);
        }
        
        .numbered-point {
            margin: 0.25rem 0 0.25rem 1.25rem;
            position: relative;
            counter-increment: item;
        }
        
        .numbered-point:before {
            content: counter(item) ".";
            position: absolute;
            left: -1.25rem;
            color: var(--accent);
        }
        
        .code-block {
            background: var(--secondary);
            padding: 0.75rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: auto;
            max-width: 100%;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .code-block::-webkit-scrollbar {
            height: 8px;
        }
        
        .code-block::-webkit-scrollbar-track {
            background: var(--secondary);
            border-radius: 4px;
        }
        
        .code-block::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }
        
        .code-block::-webkit-scrollbar-thumb:hover {
            background: #4a4aff;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--secondary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4aff;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <a href="#" class="logo">AI<span>Nexus</span></a>
            <div class="nav-links">
                <a href="/index.html" class="nav-link">Home</a>
                <a href="/profiles.html" class="nav-link">Profiles</a>
                <a href="#" class="nav-link">Playground</a>
                <a href="/dev.html" class="nav-link">Development</a>
            </div>
        </div>
    </nav>

    <div class="playground-container">
        <div class="sidebar">
            <div class="agent-selection-container">
                <select class="agent-dropdown" id="agentSelect">
                    <option value="">Select Agent</option>
                </select>
                <button class="add-agent-btn" id="addAgent">
                    Add
                </button>
            </div>
            <div id="agentToggles"></div>
        </div>
        <div class="rating-modal" id="ratingModal">
            <div class="rating-content">
                <button class="close-rating" onclick="closeRatingModal()">×</button>
                <div class="rating-header">Rate Response</div>
                <div id="ratingCategories">
                </div>
                <div class="rating-feedback">
                    <label for="feedback">Additional Feedback (Optional)</label>
                    <textarea id="feedback" placeholder="Share your thoughts..."></textarea>
                </div>
                <button class="submit-rating" onclick="submitRating()">Submit Rating</button>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    👋 Welcome to AI Nexus! Select an agent to begin chatting.
                </div>
            </div>

            <div class="message-input-container">
                <div class="message-input-wrapper">
                    <textarea 
                        class="message-input" 
                        id="messageInput"
                        placeholder="Type your message..."
                        rows="1"
                    ></textarea>
                    <button class="send-button" id="sendButton" disabled>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const EAS_CONTRACT_ADDRESS = "0xC2679fBD37d54388Ce493F1DB75320D236e1815e"; // Sepolia address
        const SCHEMA_UID = "0x0x4d65bdf2d3c9bf7b1a00b9e901b2018adf0f8423ce26b3cd90527f1241b8d968"; // Replace with your actual schema UID after registration
        
        // Initialize EAS SDK
        async function initializeEAS() {
            try {
                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask is not installed!');
                }
        
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Create provider and signer
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                
                // Initialize EAS SDK
                const eas = new window.EAS(EAS_CONTRACT_ADDRESS);
                eas.connect(signer);
        
                return eas;
            } catch (error) {
                console.error("Error initializing EAS:", error);
                throw error;
            }
        }


        const agents = [
            {
                name: "Atlas",
                specialty: "General Intelligence",
                description: "A versatile AI agent for complex reasoning and problem-solving.",
                image: "./assets/agents/atlas.avif"
            },
            {
                name: "Nova",
                specialty: "Scientific Research",
                description: "Specialized in scientific analysis and research synthesis.",
                image: "./assets/agents/nova.avif"
            },
            {
                name: "Sage",
                specialty: "Education",
                description: "Expert in educational content and tutoring.",
                image: "./assets/agents/sage.avif"
            },
            {
                name: "Minerva",
                specialty: "Education & Tutoring",
                description: "A patient and adaptable tutor specializing in personalized learning strategies and comprehensive educational support.",
                image: "./assets/agents/defailt.avif"
            },
            {
                name: "Nexus",
                specialty: "Code & Development",
                description: "Advanced coding specialist with expertise across multiple programming languages and software architecture.",
                image: "./assets/agents/sage.avif"
            },
            {
                name: "Aurora",
                specialty: "Creative Arts",
                description: "An imaginative AI focused on artistic expression, creative writing, and multimedia content creation.",
                image: "./assets/agents/archi.jpg"
            },
            {
                name: "Pythagoras",
                specialty: "Mathematical Analysis",
                description: "Expert in complex mathematical computations, statistical analysis, and mathematical problem-solving.",
                image: "./assets/agents/debug.png"
            },
            {
                name: "Lexicon",
                specialty: "Language Processing",
                description: "Specialized in natural language understanding, translation, and multilingual communication.",
                image: "./assets/agents/defailt.avif"
            },
            {
                name: "Terra",
                specialty: "Environmental Science",
                description: "Dedicated to environmental analysis, sustainability solutions, and climate science research.",
                image: "./assets/agents/optimizer.png"
            },
            {
                name: "Quantum",
                specialty: "Business Analytics",
                description: "Strategic business analyst focusing on market trends, data-driven insights, and business optimization.",
                image: "./assets/agents/nova.avif"
            },
            {
                name: "Serena",
                specialty: "Mental Health & Wellness",
                description: "Compassionate wellness guide offering support for mental health, stress management, and personal development.",
                image: "./assets/agents/atlas.avif"
            }
        ];

        const agentSelect = document.getElementById('agentSelect');
        const addAgentBtn = document.getElementById('addAgent');
        const agentToggles = document.getElementById('agentToggles');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        let activeAgents = new Set();
        let isTyping = false;
        let currentRatingAgent = null;
        let currentRatingMessageId = null;
        const ratingCategories = ['Accuracy', 'Creation', 'Problem Solving', 'Relevancy', 'Processing', 'Analysis'];
        const ratings = {};

        agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.name;
            option.textContent = agent.name;
            agentSelect.appendChild(option);
        });

        addAgentBtn.addEventListener('click', () => {
            const selectedAgent = agents.find(a => a.name === agentSelect.value);
            if (!selectedAgent) return;
            
            if (!Array.from(activeAgents).some(a => a.name === selectedAgent.name)) {
                activeAgents.add(selectedAgent);
                createAgentToggle(selectedAgent);
                updateSendButtonState();
                
                addMessage(`Hello! I'm ${selectedAgent.name}, specialized in ${selectedAgent.specialty}.`, 'ai', selectedAgent);
            }
        });

        function createAgentToggle(agent) {
            const toggle = document.createElement('div');
            toggle.className = 'agent-toggle active';
            toggle.innerHTML = `
                <img src="${agent.image}" alt="${agent.name}">
                <span>${agent.name}</span>
            `;

            toggle.addEventListener('click', () => {
                toggle.classList.toggle('active');
                if (toggle.classList.contains('active')) {
                    activeAgents.add(agent);
                } else {
                    activeAgents.delete(agent);
                }
                updateSendButtonState();
            });

            agentToggles.appendChild(toggle);
        }

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
            updateSendButtonState();
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isTyping || activeAgents.size === 0) return;
        
            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateSendButtonState();
        
            isTyping = true;
            updateSendButtonState();
            
            try {
                const activeAgentArray = Array.from(activeAgents);
                const response = await fetch('http://localhost:5000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        agents: activeAgentArray
                    })
                });
        
                const responses = await response.json();
        
                activeAgentArray.forEach((agent, index) => {
                    setTimeout(() => {
                        const agentResponse = responses[agent.name];
                        addMessage(agentResponse, 'ai', agent);
                        
                        if (index === activeAgentArray.length - 1) {
                            isTyping = false;
                            updateSendButtonState();
                        }
                    }, index * 1000);
                });
            } catch (error) {
                console.error('Error:', error);
                addMessage('An error occurred while generating responses.', 'ai');
                isTyping = false;
                updateSendButtonState();
            }
        }

        function generateResponse(agent, userMessage) {
            const responses = [
                `Based on my ${agent.specialty} expertise, I think...`,
                `From a ${agent.specialty} perspective, I'd say...`,
                `Interesting point! In ${agent.specialty}, we often...`,
                `Let me approach this from my ${agent.specialty} background...`
            ];
            return responses[Math.floor(Math.random() * responses.length)] + 
                   " " + userMessage.substring(0, 20) + "...";
        }

        function initializeRatingCategories() {
            const container = document.getElementById('ratingCategories');
            container.innerHTML = '';

            ratingCategories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'rating-category';
                div.innerHTML = `
                    <div>${category}</div>
                    <div class="rating-stars" data-category="${category.toLowerCase().replace(' ', '-')}">
                        ${Array.from({length: 5}, (_, i) => `
                            <span class="star" onclick="setRating('${category.toLowerCase().replace(' ', '-')}', ${i + 1})">★</span>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function formatMessageText(text) {
            // formatting keliye
            const lines = text.split('\n');
            let formattedContent = '';
            let inList = false;
            let listType = null;
            let listContent = '';

            for (let line of lines) {
                line = line.trim();
                
                // Skip empty lines
                if (!line) {
                    if (inList) {
                        formattedContent += listContent;
                        listContent = '';
                        inList = false;
                    }
                    formattedContent += '<br>';
                    continue;
                }

                // bullet points ke liye
                if (line.startsWith('- ') || line.startsWith('• ') || line.startsWith('* ')) {
                    if (!inList || listType !== 'bullet') {
                        if (inList) {
                            formattedContent += listContent;
                        }
                        listContent = '<div class="bullet-list">';
                        inList = true;
                        listType = 'bullet';
                    }
                    listContent += `<div class="bullet-point">${line.substring(2)}</div>`;
                    continue;
                }

                // numbered points keliye
                if (/^\d+\.\s/.test(line)) {
                    if (!inList || listType !== 'numbered') {
                        if (inList) {
                            formattedContent += listContent;
                        }
                        listContent = '<div class="numbered-list" style="counter-reset: item 0;">';
                        inList = true;
                        listType = 'numbered';
                    }
                    listContent += `<div class="numbered-point">${line.substring(line.indexOf(' ') + 1)}</div>`;
                    continue;
                }

                // VVI CODE BLOCKS XD
                if (line.startsWith('```')) {
                    if (inList) {
                        formattedContent += listContent;
                        listContent = '';
                        inList = false;
                    }
                    formattedContent += '<div class="code-block">';
                    continue;
                }
                if (line.endsWith('```')) {
                    formattedContent += '</div>';
                    continue;
                }

                if (line.startsWith('#')) {
                    if (inList) {
                        formattedContent += listContent;
                        listContent = '';
                        inList = false;
                    }
                    const level = line.match(/^#+/)[0].length;
                    const text = line.substring(level).trim();
                    formattedContent += `<h${level}>${text}</h${level}>`;
                    continue;
                }

                if (!inList) {
                    formattedContent += `<p>${line}</p>`;
                } else {
                    formattedContent += listContent + '</div>';
                    formattedContent += `<p>${line}</p>`;
                    inList = false;
                    listContent = '';
                }
            }

            if (inList) {
                formattedContent += listContent + '</div>';
            }

            return formattedContent;
        }

        // Add message to chat
        function addMessage(text, type, agent = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message animate__animated animate__fadeIn`;
            
            if (type === 'ai' && agent) {
                const messageId = `msg-${Date.now()}`;
                messageDiv.setAttribute('data-message-id', messageId);
                
                messageDiv.innerHTML = `
                    <div class="agent-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <img src="${agent.image}" alt="${agent.name}" style="width: 24px; height: 24px; border-radius: 50%;">
                        <span style="color: var(--accent)">${agent.name}</span>
                        <button class="rating-button" onclick="openRatingModal('${agent.name}', '${messageId}')">Rate Response</button>
                    </div>
                    <div class="message-content">
                        ${formatMessageText(text)}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        ${formatMessageText(text)}
                    </div>
                `;
            }
        
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        
        function openRatingModal(agentName, messageId) {
            currentRatingAgent = agentName;
            currentRatingMessageId = messageId;
            document.getElementById('ratingModal').classList.add('active');
            initializeRatingCategories();
            // Reset ratings FUTURE USE KELIYE
            ratingCategories.forEach(category => {
                ratings[category.toLowerCase().replace(' ', '-')] = 0;
            });
            document.getElementById('feedback').value = '';
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('active');
            currentRatingAgent = null;
            currentRatingMessageId = null;
        }

        function setRating(category, value) {
            ratings[category] = value;
            const stars = document.querySelector(`[data-category="${category}"]`).children;
            Array.from(stars).forEach((star, index) => {
                star.classList.toggle('active', index < value);
            });
        }

        async function submitRating() {
            try {
                const feedback = document.getElementById('feedback').value;
                
                // Convert ratings object to array of numbers
                const ratingsArray = ratingCategories.map(category => 
                    parseInt(ratings[category.toLowerCase().replace(' ', '-')] || 0)
                );

                // Ensure we have exactly 6 ratings
                while (ratingsArray.length < 6) {
                    ratingsArray.push(0);
                }
                
                const ratingData = {
                    agentName: currentRatingAgent,
                    messageId: currentRatingMessageId,
                    ratings: ratingsArray,
                    feedback: feedback,
                    timestamp: Math.floor(Date.now() / 1000)
                };

                // Initialize EAS
                const eas = await initializeEAS();

                // Create SchemaEncoder instance
                const schemaEncoder = new window.EAS.SchemaEncoder("string agentName,string messageId,uint8[6] ratings,string feedback,uint256 timestamp");

                // Encode the data
                const encodedData = schemaEncoder.encodeData([
                    { name: "agentName", value: ratingData.agentName, type: "string" },
                    { name: "messageId", value: ratingData.messageId, type: "string" },
                    { name: "ratings", value: ratingData.ratings, type: "uint8[6]" },
                    { name: "feedback", value: ratingData.feedback, type: "string" },
                    { name: "timestamp", value: ratingData.timestamp, type: "uint256" }
                ]);

                // Show loading message
                addMessage('Processing rating submission...', 'ai');

                // Create the attestation
                const tx = await eas.attest({
                    schema: SCHEMA_UID,
                    data: {
                        recipient: "0x0000000000000000000000000000000000000000",
                        expirationTime: 0,
                        revocable: true,
                        data: encodedData
                    }
                });

                // Wait for transaction confirmation
                const receipt = await tx.wait();
                
                console.log("Attestation created:", receipt);
                
                // Show success message
                addMessage(`Rating submitted successfully! View it on Sepolia EAS Scan: 
                    https://sepolia.easscan.org/attestation/view/${receipt.transactionHash}`, 'ai');
                
                closeRatingModal();
                
            } catch (error) {
                console.error('Error submitting rating:', error);
                addMessage('Error submitting rating: ' + error.message, 'ai');
            }
        }
        // Add MetaMask connection button and status
        function addMetaMaskButton() {
            const navContent = document.querySelector('.nav-content');
            const metaMaskDiv = document.createElement('div');
            metaMaskDiv.className = 'metamask-status';
            metaMaskDiv.innerHTML = `
                <button id="connectMetaMask" class="metamask-button">
                    Connect MetaMask
                </button>
                <span id="walletStatus"></span>
            `;
            navContent.appendChild(metaMaskDiv);

            // Add event listener
            document.getElementById('connectMetaMask').addEventListener('click', async () => {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        document.getElementById('walletStatus').textContent = 
                            `Connected: ${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}`;
                    }
                } catch (error) {
                    console.error(error);
                    addMessage('Failed to connect to MetaMask', 'ai');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            addMetaMaskButton();
            initChat();
        });



        function updateSendButtonState() {
            const hasText = messageInput.value.trim().length > 0;
            const hasAgents = activeAgents.size > 0;
            sendButton.disabled = !hasText || !hasAgents || isTyping;
        }
        updateSendButtonState();
        // Typing indctor blinking wala
        function showTypingIndicator() {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'typing-indicator';
            indicatorDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatMessages.appendChild(indicatorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = chatMessages.querySelector('.typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // thoda sa translation when agent switch kiya
        function animateAgentTransition(agentToggle) {
            agentToggle.style.transform = 'translateX(10px)';
            setTimeout(() => {
                agentToggle.style.transform = 'translateX(0)';
            }, 200);
        }

        function clearChat() {
            while (chatMessages.firstChild) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
            addMessage('Chat cleared. Select agents to start a new conversation.', 'ai');
        }

        let messageCount = 0;

        function updateMessageCount() {
            messageCount++;
            const countDisplay = document.createElement('div');
            countDisplay.style.position = 'absolute';
            countDisplay.style.right = '10px';
            countDisplay.style.top = '10px';
            countDisplay.style.color = 'var(--text)';
            countDisplay.textContent = `Messages: ${messageCount}`;
            chatMessages.appendChild(countDisplay);
        }

        chatMessages.addEventListener('scroll', () => {
            if (chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight) {
                chatMessages.classList.add('at-bottom');
            } else {
                chatMessages.classList.remove('at-bottom');
            }
        });

        window.addEventListener('resize', () => {
            if (messageInput) {
                messageInput.style.height = 'auto';
                messageInput.style.height = messageInput.scrollHeight + 'px';
            }
        });

        function handleError(error) {
            console.error('Error:', error);
            addMessage('An error occurred. Please try again.', 'ai');
            isTyping = false;
            updateSendButtonState();
        }

        function initChat() {
            clearChat();
            addMessage('👋 Welcome to AI Nexus! Select an agent to begin chatting.', 'ai');
            activeAgents.clear();
            messageCount = 0;
            isTyping = false;
            updateSendButtonState();
            while (agentToggles.firstChild) {
                agentToggles.removeChild(agentToggles.firstChild);
            }
        }

        // initialization of page yaha
        document.addEventListener('DOMContentLoaded', initChat);

    </script>
</body>
</html>